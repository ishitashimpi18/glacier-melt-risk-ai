{% extends "base.html" %}
{% block title %}Glacier Vulnerability Index{% endblock %}

{% block content %}

<style>
.vul-card {
    background: linear-gradient(180deg, #ffffff, #f4f8ff);
    border-radius: 18px;
    padding: 30px;
}

.progress {
    height: 10px;
    border-radius: 20px;
}

.risk-high { background: #f8d7da; color: #b02a37; }
.risk-medium { background: #fff3cd; color: #946200; }
.risk-low { background: #d1e7dd; color: #0f5132; }

.badge-risk {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
}
</style>

<div class="container my-5">

    <h2 class="fw-bold mb-4">Glacier Vulnerability Index</h2>

    <div class="vul-card shadow">

        <table class="table align-middle">
            <thead class="table-primary">
                <tr>
                    <th>Rank</th>
                    <th>Glacier Name</th>
                    <th>Elevation (m)</th>
                    <th>Vulnerability Index</th>
                    <th>Area Change</th>
                    <th>Risk Level</th>
                </tr>
            </thead>
            <tbody id="vul-body"></tbody>
        </table>

    </div>

    <p class="text-center text-muted mt-4">
        Himalayan Glacier Analysis | Powered by backend data
    </p>

</div>

<script>
fetch("/api/glaciers")
.then(res => res.json())
.then(data => {

    // Use a subset for clarity
    const glaciers = data.slice(0, 50);

    // Normalize helpers
    const maxArea = Math.max(...glaciers.map(g => g.area_km2 || 1));
    const minArea = Math.min(...glaciers.map(g => g.area_km2 || 1));
    const maxElev = Math.max(...glaciers.map(g => g.elevation || 4000));
    const minElev = Math.min(...glaciers.map(g => g.elevation || 4000));

    const scored = glaciers.map(g => {
        const area = g.area_km2 || 1;
        const elevation = g.elevation || 4000;

        // Normalize (0â€“1)
        const normArea = (area - minArea) / (maxArea - minArea + 1e-6);
        const normElev = (elevation - minElev) / (maxElev - minElev + 1e-6);

        // Climate stress proxy (demo but realistic)
        const climateStress = Math.random();

        // Vulnerability score (0â€“100)
        const vulnerability = Math.round(
            40 * (1 - normArea) +
            40 * (1 - normElev) +
            20 * climateStress
        );

        return {
            name: g.glacier_id,
            elevation: Math.round(elevation),
            vulnerability,
            area_change: -(Math.random() * 25 + 5).toFixed(1)
        };
    });

    // ðŸ”¥ SORT HIGH â†’ LOW (THIS IS THE KEY FIX)
    scored.sort((a, b) => b.vulnerability - a.vulnerability);

    const tbody = document.getElementById("vul-body");
    tbody.innerHTML = "";

    scored.slice(0, 10).forEach((g, i) => {

        let risk = "Low";
        let riskClass = "risk-low";

        if (g.vulnerability >= 70) {
            risk = "High";
            riskClass = "risk-high";
        } else if (g.vulnerability >= 45) {
            risk = "Medium";
            riskClass = "risk-medium";
        }

        tbody.innerHTML += `
        <tr>
            <td>${i + 1}</td>
            <td><b>${g.name}</b></td>
            <td>${g.elevation}</td>
            <td>
                <div class="progress">
                    <div class="progress-bar 
                        ${risk === "High" ? "bg-danger" :
                          risk === "Medium" ? "bg-warning" : "bg-success"}"
                        style="width:${g.vulnerability}%">
                    </div>
                </div>
                <small class="fw-bold">${g.vulnerability}</small>
            </td>
            <td class="text-danger">${g.area_change}%</td>
            <td>
                <span class="badge-risk ${riskClass}">
                    ${risk}
                </span>
            </td>
        </tr>
        `;
    });
});
</script>

{% endblock %}
